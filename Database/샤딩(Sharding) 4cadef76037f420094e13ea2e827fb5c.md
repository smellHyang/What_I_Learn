# 샤딩(Sharding)

1. 샤딩? 
    - 데이터를 분산하여 저장하는개념(Horizontal Partitioning)
    
    <aside>
    💡 Horizontal Partitioning ? row기준으로 테이블을 분산시키는것.  분할된 테이블은 같은 스키마를 갖는다.
    
    </aside>
    
    +) Verical Partitioning?
    
    - colum기준으로 테이블을 분산시키는것. 자주사용하는 컬럼을 분리시켜 성능을 향상시킨다.
    
    ![Untitled](%E1%84%89%E1%85%A3%E1%84%83%E1%85%B5%E1%86%BC(Sharding)%204cadef76037f420094e13ea2e827fb5c/Untitled.png)
    

1. 고려 사항
    - 샤드간 cross-join이 불가능하여 역정규화를 감수해야한다.
    - 하나의 트랜잭션에서 두개 이상의 샤드에 접근 할 수 없다.
    - 모든 샤드에 대해 유니크한 shard id 생성이 필요하다. DB외부에서 shard id를 관리하기 위한 별도의 어플리케이션 운영이 필요함(라우터 사용)
    - 안정성을 위해 각 샤드의 Replica set구성이 필요하다
    - 서비스 정지 없이 샤딩 할 수 있도록 설계해야한다.

1. 샤딩 방법
    - **Range based sharding**
        - 연속적인 숫자나 날짜기준으로 행해지고 데이터가 특정 범위 안에 드는 경우 분리
        - e.g. 1-6월, 7-12월로 분리/ 1000원-5000원, 5000원-10000원
        - 각 샤드는 다른데이터를 가지고 있지만 똑같은 스키마를 가진다.
        - 장점) 어떤 범위 인지 읽고 그에 상응하는 샤드를 쓰면 되므로 실행이 비교적 간단하고 관리가 쉽다.
        - 단점) 데이터베이스가 골고루 분배되지 못해 특정데이터가 다른데이터에 비해 읽는 횟수가 더 많아져 불균형을 가져올수 있다.
    - **Key based sharding(Hash based sharding)**
        - 데이터를 해시함수의 값에 따라 분리한다 → 데이터의 key를 해싱하여 일치하는 shard id를 갖는 shard로 분리)
        - 장점) 데이터를 골고루 분배할 수 있고 직접 데이터 위치를 지정할 필요가 없다.
        - 단점) 모든 데이터에 hash함수를 사용해야해서 다시 맵핑되는 동안 기존에 사용하던 데이터의 사용을 정지해야 할 수 있다.
    - **Directory based sharding**
        - 데이터 값이 특정 목록 안에 포함될 경우 분리
        - e.g. Country컬럼값이 [‘KOREA’, ’JAPAN’, ‘CHINA’]에 포함되는 경우 분리
        - 반드시 어떤 샤드가 어떤 데이터를 갖고 있는지 추적할 수 있는 shard id를 사용하는 lookkup table을 만들고 유지해야한다. → lookup 테이블에서 id를 보고 어디에 데이터를 쓸지 결정한다.
        - list안에 값이 테이블에 많이 포함되어 있는 경우 유용하다.
        - 장점) range샤드는 범위가 국한되고 key샤드는 만들고 난후 바꾸기 어렵다. 하지만 directory샤드는 어떤 시스템이나 알고리즘에 상관없이 값을 할당할 수 있도록 해준다. 따라서 동적으로 샤드를 추가하는게 비교적 쉬움
        - 단점) lookup table 연결이 필요하기 때문에 안좋은 영향을 줄 수 있다. 이 테이블이 손상되면 데이터를 새로쓰거나 데이터에 접근하는 것에 영향을 줄 수 있다.
        
2. 장점
    - 데이터 분산 및 수평적 확장
        - 데이터를 분산하여 순차적으로 저장하면 트래픽을 분산시쳐 부하를 줄여준다.
    - 백업 및 복구(안정성)
        - 미리 데이터를 분산하여 저장해두면 리스크로부터 보호받을 수 있다.
        - 장애가 샤드 단위로 발생하여 하나가 중단될경우 다른 샤드로 사용가능
    - 빠른 성능
        - 여러대의 독립된 프로세스가 병렬로 작업을 동시에 수행하기 때문에 빠른 성능 보장
        - 스캔 범위를 줄여 쿼리 반응 속도가 빠름

1. 단점
    - 잘못 사용했을 경우 리스크가 크다 (데이터 손상, 유실..)
    - 데이터가 한쪽으로 몰리게 되면 sharding이 무의미해짐
    - 한번 분산하면 다시 원래상태로 돌리기 어렵다.
    - 모든 데이터베이스 엔진에서 지원되는건 아니다.